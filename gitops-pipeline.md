# Configuring ArgoCD GitOps Pipeline

1. Clone this [GitOps Repo](https://github.com/dambor/gitops.git)

```
git clone https://github.com/dambor/gitops.git
```

2. Change the service yaml file at `gitops/petclinic-knative/petclinic.yaml` to reference to you 

```
apiVersion: serving.knative.dev/v1 # Current version of Knative
kind: Service
metadata:
  name: petclinic # The name of the app
  namespace: default # The namespace the app will use
spec:
  template:
    spec:
      containers:
        - image: index.docker.io/<YOUR-DOCKER-REPO>/petclinic:<YOUR-TAG> # generated by kpack
```

2. Login to your ArgoCD install using the ArgoCD CLI and create a new pipeline:

```
argocd app create petclinic \
--repo https://github.com/<YOUR-REPO>/gitops.git \
--path petclinic-knative \
--dest-namespace default \
--dest-server https://kubernetes.default.svc \
--directory-recurse --sync-policy automated
```

3. Login to the ArgoCD web interface and check the status of your pipeline. It should link similar to the one below:

![argocd-pipe](https://github.com/dambor/devplatform/blob/master/png/argocd-pipeline.png)

4. On your Knative deployment check the revision applied:

```
kn revision list
NAME                  SERVICE         TRAFFIC   TAGS   GENERATION   AGE     CONDITIONS   READY   REASON
petclinic-8rdjp       petclinic       100%             1            29m     3 OK / 4     True
```

```
kubectl get ksvc
NAME            URL                                                LATESTCREATED         LATESTREADY           READY   REASON
petclinic       http://petclinic.default.knative.gdambor.com       petclinic-8rdjp       petclinic-8rdjp       True
```
5. Access the application on a browser (cold start for spring app should take about 15 seconds):

![petclinic](https://github.com/dambor/devplatform/blob/master/png/petclinic.png)

